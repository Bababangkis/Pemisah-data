<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pembersih Data Pro - Versi 16.0</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 25px; background-color: #f0f2f5; }
        .container { max-width: 1350px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h2 { color: #1b5e20; border-bottom: 2px solid #1b5e20; padding-bottom: 10px; margin-top: 0; }
        
        /* Gaya Panel Panduan */
        .instruction-box { background-color: #e8f5e9; border-left: 5px solid #2e7d32; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .instruction-box h4 { margin-top: 0; color: #2e7d32; }
        .instruction-box ul { margin: 0; padding-left: 20px; font-size: 14px; color: #333; }
        
        textarea { width: 100%; height: 180px; border: 1px solid #ced4da; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 14px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-process { background-color: #2e7d32; color: white; }
        .btn-download { background-color: #0d47a1; color: white; }
        .btn-clear { background-color: #c62828; color: white; }
        button:hover { opacity: 0.8; }
        
        .excel-text { mso-number-format:"\@"; } /* Kode Excel untuk Teks */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 13px; }
        th { background-color: #f8f9fa; position: sticky; top: 0; }
        .hp-col { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Tabel Pemisah </h2>

    <div class="instruction-box">
        <h4>üìù Tata Cara Input yang Benar:</h4>
        <ul>
            <li>Pastikan setiap <b>satu data pelanggan</b> dipisahkan oleh <b>satu baris kosong</b> (Enter 2x).</li>
            <li>Urutan baris di dalam satu data bebas, namun pastikan ada <b>Nama, Alamat, No HP, Berat (kg),</b> dan <b>Jumlah (pcs)</b>.</li>
            <li>No HP bisa ditulis dengan format 012..., 601..., atau +601... (Sistem akan otomatis mengubahnya ke +60).</li>
            <li>Pastikan penulisan berat diakhiri kata <b>"kg"</b> (Contoh: 1 kg) dan jumlah diakhiri kata <b>"pcs"</b> (Contoh: 2 pcs).</li>
            <li>Setelah data ditempel, klik tombol <b>"TAMBAH KE TABEL"</b> lalu <b>"UNDUH EXCEL"</b> untuk menyimpan.</li>
        </ul>
    </div>

    <textarea id="inputData" placeholder="Tempelkan data di sini...&#10;&#10;Contoh:&#10;AKBAR SULIATRI&#10;JLN MAT RAJI, SHAH ALAM&#10;01123639350&#10;1 kg&#10;2 pcs"></textarea>
    
    <div class="btn-group">
        <button class="btn-process" onclick="prosesData()">TAMBAH KE TABEL</button>
        <button class="btn-download" onclick="exportTableToExcel('hasilTable')">UNDUH EXCEL</button>
        <button class="btn-clear" onclick="hapusTabel()">HAPUS SEMUA</button>
    </div>

    <table id="hasilTable">
        <thead>
            <tr>
                <th>No</th>
                <th>Nama</th>
                <th>No HP (+60)</th>
                <th>Berat (kg)</th>
                <th>Jumlah (pcs)</th>
                <th>Total Harga (MYR)</th>
                <th>Kode Pos</th>
                <th>Alamat Lengkap</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    let rowCount = 0;
    const HARGA_SATUAN = 11.77;

    function formatPhone(phone) {
        let clean = phone.replace(/\D/g, ''); 
        if (clean.startsWith('0')) { clean = '60' + clean.substring(1); }
        else if (clean.startsWith('1')) { clean = '60' + clean; }
        return '+' + clean.substring(0, 12); // Membatasi agar angka berat tidak masuk
    }

    function prosesData() {
        const input = document.getElementById('inputData').value;
        const blocks = input.split(/\n\s*\n/); 
        const tbody = document.getElementById('tableBody');

        blocks.forEach(block => {
            if (block.trim() === "") return;
            let lines = block.split('\n').map(l => l.trim()).filter(l => l !== "");
            
            let rawPhone = "";
            let weightVal = "0";
            let pcsVal = "1";
            let zip = "-";
            let nama = lines[0].toUpperCase();

            lines.forEach(line => {
                let lowerLine = line.toLowerCase();
                if (line.replace(/\D/g, '').length >= 9 && !lowerLine.includes('kg') && !lowerLine.includes('pcs')) {
                    rawPhone = line;
                }
                let wMatch = line.match(/(\d+(\.\d+)?)\s?kg\b/i);
                if (wMatch) weightVal = wMatch[1];
                let pMatch = line.match(/(\d+)\s?pcs/i);
                if (pMatch) pcsVal = pMatch[1];
                let zMatch = line.match(/\b\d{5}\b/);
                if (zMatch) zip = zMatch[0];
            });

            let formattedPhone = rawPhone ? formatPhone(rawPhone) : "-";
            let totalHarga = (parseFloat(pcsVal) * HARGA_SATUAN).toFixed(2);

            let addressLines = lines.filter(l => {
                let lowerL = l.toLowerCase();
                let isName = l.toUpperCase() === nama;
                let isPhone = rawPhone && l.includes(rawPhone);
                let isWeight = /(\d+(\.\d+)?)\s?kg\b/i.test(l);
                let isPcs = /\d+\s?pcs/i.test(l);
                return !isName && !isPhone && !isWeight && !isPcs;
            });

            let fullAddress = addressLines.join(", ");
            if (zip !== "-") fullAddress = fullAddress.replace(zip, "");
            fullAddress = fullAddress.replace(/nama\s*:\s*|alamat\s*:\s*|no telefon\s*:\s*|tel\s*:\s*/gi, "");
            fullAddress = fullAddress.replace(/,\s*,/g, ",").trim().replace(/^,+|,+$/g, "").replace(/\s+/g, " ");

            rowCount++;
            let row = tbody.insertRow();
            row.innerHTML = `
                <td>${rowCount}</td>
                <td>${nama}</td>
                <td class="excel-text hp-col">${formattedPhone}</td>
                <td>${weightVal}</td>
                <td>${pcsVal}</td>
                <td class="excel-price">${totalHarga}</td>
                <td class="excel-text">${zip}</td>
                <td>${fullAddress}</td>
            `;
        });
        document.getElementById('inputData').value = ''; 
    }

    function exportTableToExcel(tableID) {
        let table = document.getElementById(tableID);
        // Menambahkan tanda kutip satu di Excel agar tetap terbaca teks/plus (+)
        let excelFormat = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <style>
                    .excel-text { mso-number-format:"\\@"; }
                    .excel-price { mso-number-format:"\\#\\,\\#\\#0\\.00"; }
                </style>
            </head>
            <body>${table.outerHTML.replace(/\+60/g, "'+60")}</body>
            </html>`;
        let blob = new Blob(['\ufeff', excelFormat], { type: 'application/vnd.ms-excel' });
        let url = URL.createObjectURL(blob);
        let a = document.createElement("a");
        a.href = url;
        a.download = "data_pelanggan_siap.xls";
        a.click();
    }

    function hapusTabel() {
        if (confirm("Hapus semua data di tabel?")) {
            document.getElementById('tableBody').innerHTML = '';
            rowCount = 0;
        }
    }
</script>

</body>
</html>